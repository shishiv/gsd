---
phase: 03-process-and-signal-guards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/chipset/blitter/executor.ts
  - src/storage/skill-store.ts
  - src/detection/skill-generator.ts
  - src/cli/commands/terminal.ts
autonomous: true
requirements:
  - PROC-01
  - PROC-02

must_haves:
  truths:
    - "When the executor times out a child process on Windows, the child terminates instead of being orphaned"
    - "chmod calls in executor.ts, skill-store.ts, skill-generator.ts, and terminal.ts do not execute on Windows"
    - "All existing tests still pass after platform guards are added"
  artifacts:
    - path: "src/chipset/blitter/executor.ts"
      provides: "Platform-guarded process group kill and chmod skip"
      contains: "process.platform !== 'win32'"
    - path: "src/storage/skill-store.ts"
      provides: "Platform-guarded chmod skip for script files"
      contains: "process.platform !== 'win32'"
    - path: "src/detection/skill-generator.ts"
      provides: "Platform-guarded chmod skip for executable scripts"
      contains: "process.platform !== 'win32'"
    - path: "src/cli/commands/terminal.ts"
      provides: "Platform-guarded chmodSync skip for launch script"
      contains: "process.platform !== 'win32'"
  key_links:
    - from: "src/chipset/blitter/executor.ts"
      to: "process.kill(-child.pid)"
      via: "platform guard wrapping negative-PID kill"
      pattern: "process\\.platform !== 'win32'"
---

<objective>
Add platform guards around process group kill (`process.kill(-child.pid)`) and `chmod`/`chmodSync` calls in four production files to prevent Windows runtime failures.

Purpose: `process.kill(-child.pid)` throws ESRCH on Windows (negative PIDs not supported by libuv). `chmod` is a silent no-op on Windows NTFS but should be explicitly skipped for code clarity. These guards ensure the executor properly terminates timed-out child processes on Windows and chmod calls are skipped where they have no effect.

Output: Four production files with platform-specific guards; all existing tests pass.
</objective>

<execution_context>
@C:/Users/Myke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Myke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-process-and-signal-guards/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add platform guard around process.kill(-child.pid) in executor.ts (PROC-01) and chmod (PROC-02)</name>
  <files>src/chipset/blitter/executor.ts</files>
  <action>
In `executeOffloadOp()`, modify the timeout handler (lines 94-106) to guard the negative-PID kill with a platform check:

**Before (current code):**
```typescript
if (child.pid) {
  try {
    process.kill(-child.pid, 'SIGTERM');
  } catch {
    child.kill('SIGTERM');
  }
} else {
  child.kill('SIGTERM');
}
```

**After:**
```typescript
if (child.pid && process.platform !== 'win32') {
  // Unix: kill the entire process group so child processes are also terminated
  try {
    process.kill(-child.pid, 'SIGTERM');
  } catch {
    // Process may have already exited
    child.kill('SIGTERM');
  }
} else {
  // Windows: process groups not supported; kill the direct child
  // child.kill() maps SIGTERM to force-terminate on Windows
  child.kill('SIGTERM');
}
```

Also wrap the chmod call (line 55) with a platform guard:

**Before:**
```typescript
if (operation.scriptType === 'bash' || operation.scriptType === 'custom') {
  await chmod(scriptPath, 0o755);
}
```

**After:**
```typescript
if ((operation.scriptType === 'bash' || operation.scriptType === 'custom') && process.platform !== 'win32') {
  // chmod is a no-op on Windows NTFS; skip explicitly
  await chmod(scriptPath, 0o755);
}
```

Do NOT change the `detached: true` option on the spawn call — it is required for Unix process group kills. Do NOT modify the `writeFile` call with `mode: 0o755` on line 51 — that is handled by the filesystem and is harmless on Windows.

**Note:** Three test files also contain chmod calls (executor.test.ts, disclosure/integration.test.ts, dashboard/generator.test.ts). These do NOT need code changes — chmod silently succeeds on Windows NTFS and does not throw, so test files are not a runtime risk. Verify this by confirming `npx vitest run` passes on Windows without modification to test files.
  </action>
  <verify>Run `npx vitest run src/chipset/blitter/executor.test.ts` — all existing tests pass. Grep for `process.platform` in the file to confirm both guards exist.</verify>
  <done>executor.ts has platform guard around `process.kill(-child.pid)` (PROC-01) and chmod (PROC-02); all executor tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add platform guards around chmod in skill-store.ts, skill-generator.ts, and terminal.ts (PROC-02)</name>
  <files>src/storage/skill-store.ts, src/detection/skill-generator.ts, src/cli/commands/terminal.ts</files>
  <action>
Apply the same platform-guard pattern to all three remaining production chmod call sites:

**skill-store.ts (line 365):**

Before:
```typescript
await chmod(scriptPath, 0o755);
```

After:
```typescript
// chmod is a no-op on Windows NTFS; skip explicitly
if (process.platform !== 'win32') {
  await chmod(scriptPath, 0o755);
}
```

**skill-generator.ts (line 137):**

Before:
```typescript
if (script.executable) {
  await chmod(scriptPath, 0o755);
}
```

After:
```typescript
if (script.executable && process.platform !== 'win32') {
  // chmod is a no-op on Windows NTFS; skip explicitly
  await chmod(scriptPath, 0o755);
}
```

**terminal.ts (line 194):**

Before:
```typescript
chmodSync(scriptPath, 0o755);
```

After:
```typescript
// chmodSync is a no-op on Windows NTFS; skip explicitly
if (process.platform !== 'win32') {
  chmodSync(scriptPath, 0o755);
}
```

Keep the `chmod` / `chmodSync` imports — they are still used on non-Windows platforms. Do NOT modify test files (executor.test.ts, integration.test.ts, generator.test.ts) — chmod does not throw on Windows so test files are not a runtime risk. The 3 test files satisfy PROC-02's "all 6 files" scope through verification (no-op on Windows), not code changes.
  </action>
  <verify>Run `npx vitest run` to confirm all tests pass across the full test suite. Grep `process.platform` across the three files to confirm guards exist.</verify>
  <done>All four production chmod call sites (executor.ts + 3 files in this task) have platform guards; full test suite passes.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` — full test suite passes with zero failures
2. `grep -rn "process.platform" src/chipset/blitter/executor.ts src/storage/skill-store.ts src/detection/skill-generator.ts src/cli/commands/terminal.ts` — all 5 guard sites present (2 in executor.ts, 1 in each other file)
3. `grep -rn "process.kill(-child.pid" src/chipset/blitter/executor.ts` — negative PID kill only inside `process.platform !== 'win32'` branch
4. No new dependencies added (verify package.json unchanged)
</verification>

<success_criteria>
- process.kill(-child.pid) is only called on non-Windows platforms
- All 4 production chmod/chmodSync calls are skipped on Windows via explicit platform guard
- All existing tests pass
- No new runtime dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/03-process-and-signal-guards/03-01-SUMMARY.md`
</output>

---
phase: 02-path-construction-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/learning/version-manager.ts
autonomous: true
requirements:
  - PATH-01
  - PATH-02

must_haves:
  truths:
    - "VersionManager constructs all file paths using path.join(), never template string concatenation"
    - "VersionManager executes git commands via execFile() with argv arrays, never shell-interpreted strings"
    - "Git show hash:path and git checkout hash -- path use forward-slash paths for git's internal POSIX object store"
    - "Existing tests pass after migration (behavioral equivalence)"
  artifacts:
    - path: "src/learning/version-manager.ts"
      provides: "Git-based skill versioning with cross-platform path and process handling"
      contains: "execFileAsync"
      min_lines: 100
  key_links:
    - from: "src/learning/version-manager.ts"
      to: "git executable"
      via: "execFile('git', args, {cwd})"
      pattern: "execFileAsync\\('git'"
    - from: "src/learning/version-manager.ts"
      to: "skill files on disk"
      via: "path.join for skill path construction"
      pattern: "join\\(this\\.skillsDir"
---

<objective>
Migrate `version-manager.ts` from shell-string `exec()` to argv-array `execFile()` for all git operations, and replace all template-string path construction with `path.join()`.

Purpose: `exec()` passes commands through the system shell, which on Windows is `cmd.exe` — backslash paths get interpreted as escape sequences, and paths with spaces break silently. `execFile()` bypasses the shell entirely, passing each argument as a separate argv element. This is the single most consequential cross-platform bug fix in Phase 2.

Output: `version-manager.ts` rewritten to use `execFile()` and `path.join()` throughout.
</objective>

<execution_context>
@C:/Users/Myke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Myke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-path-construction-audit/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate version-manager.ts imports, constructor, and git() method</name>
  <files>src/learning/version-manager.ts</files>
  <action>
**Import changes (lines 1-5):**
- Replace `import { exec } from 'child_process';` with `import { execFile } from 'child_process';`
- Replace `const execAsync = promisify(exec);` with `const execFileAsync = promisify(execFile);`
- Add `import { join } from 'path';`

**Constructor default (line 23):**
- Change: `constructor(skillsDir = '.claude/skills', workDir = '.')`
- To: `constructor(skillsDir = join('.claude', 'skills'), workDir = '.')`

**git() method (lines 31-37):**
- Change signature from `git(command: string): Promise<string>` to `git(args: string[]): Promise<string>`
- Change body from `execAsync(command, ...)` to `execFileAsync('git', args, { encoding: 'utf8' as BufferEncoding, cwd: this.workDir })`
- Return `stdout.trim()` (keep existing behavior)

Note: `execFileAsync` with `promisify(execFile)` returns `{ stdout, stderr }` same as `promisify(exec)`.
  </action>
  <verify>TypeScript compiles after this task (all call sites will be updated in Task 2).</verify>
  <done>Imports updated to execFile, constructor uses path.join(), git() method accepts string[] args.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite all git() call sites to use argv arrays and path.join()</name>
  <files>src/learning/version-manager.ts</files>
  <action>
Rewrite all 5 methods that call `this.git()`. For each, replace the template-string `skillPath` with `join(this.skillsDir, skillName, 'SKILL.md')` and replace shell command strings with argv arrays.

**getHistory() (line 42-81):**
- Path: `const skillPath = join(this.skillsDir, skillName, 'SKILL.md');`
- Call: `this.git(['log', '--format=%H|%h|%ai|%s', '--follow', '--', skillPath])`
- Note: Remove the surrounding quotes from `--format` — no shell means no quote interpretation needed. Use `--format=%H|%h|%ai|%s` directly (no wrapping quotes).

**getVersionContent() (line 87-99):**
- Path: `const skillPath = join(this.skillsDir, skillName, 'SKILL.md');`
- Git show uses colon syntax `hash:path` where path must be POSIX format for git's object store.
- Convert to forward slashes: `const gitPath = skillPath.replace(/\\\\/g, '/');`
- Call: `this.git(['show', \`\${hash}:\${gitPath}\`])`
- Note: The `hash:path` is a single argument to git, not shell-interpreted.

**rollback() (lines 105-148):**
- Path: `const skillPath = join(this.skillsDir, skillName, 'SKILL.md');`
- Convert for git object store: `const gitPath = skillPath.replace(/\\\\/g, '/');`
- Checkout: `this.git(['checkout', targetHash, '--', gitPath])`
- Add: `this.git(['add', gitPath])`
- Commit: `this.git(['commit', '-m', commitMessage])`
- Note: git commit `-m` value is a separate argv element — no shell quoting needed.

**compareVersions() (lines 153-162):**
- Path: `const skillPath = join(this.skillsDir, skillName, 'SKILL.md');`
- Call: `this.git(['diff', hash1, hash2, '--', skillPath])`

**getCurrentHash() (lines 167-176):**
- Path: `const skillPath = join(this.skillsDir, skillName, 'SKILL.md');`
- Call: `this.git(['log', '-1', '--format=%H', '--', skillPath])`

**Critical detail for `git show` and `git checkout`:** Git internally uses POSIX paths in its object store. When `path.join()` produces backslash paths on Windows, the `hash:path` colon-syntax in `git show` will fail. Apply `.replace(/\\\\/g, '/')` to convert backslashes to forward slashes ONLY for the path portion used with git's colon-syntax and git object addressing. For `git log -- path` and `git diff -- path`, git handles native paths correctly via argv.

**Verification after all changes:** Run `npx tsc --noEmit` and `npx vitest run` to confirm compilation and test pass.
  </action>
  <verify>
`npx tsc --noEmit` passes. `npx vitest run --reporter=verbose src/learning/version-manager.test.ts` passes (if test file exists). Full `npx vitest run` passes.
  </verify>
  <done>
All 5 git call sites use argv arrays via execFile(). All path construction uses path.join(). Git object-store paths use forward slashes. No shell interpolation remains in version-manager.ts.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vitest run` passes all existing tests
3. Grep for `execAsync` in `version-manager.ts` returns zero matches (fully migrated to execFileAsync)
4. Grep for template literal path construction (`` `${this.skillsDir}/ ``) returns zero matches
5. No `exec` import remains (only `execFile`)
</verification>

<success_criteria>
- `version-manager.ts` uses `execFile()` exclusively for all git operations
- All path construction uses `path.join()`, no template-string concatenation
- Git object-store paths (show, checkout) use forward slashes via `.replace()`
- All existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-path-construction-audit/02-02-SUMMARY.md`
</output>
